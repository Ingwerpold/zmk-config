From 983e408866afecb57206c0608ffee987766f78dd Mon Sep 17 00:00:00 2001
From: pashutk <me@pashutk.ru>
Date: Sun, 15 Aug 2021 17:47:34 +0000
Subject: [PATCH 1/4] Add nrfmicro_13_52833 support

---
 app/boards/arm/nrfmicro/Kconfig               |   4 +-
 app/boards/arm/nrfmicro/Kconfig.board         |   4 +
 app/boards/arm/nrfmicro/Kconfig.defconfig     |   8 +-
 app/boards/arm/nrfmicro/nrfmicro_13_52833.dts | 115 ++++++++++++++++++
 .../arm/nrfmicro/nrfmicro_13_52833.yaml       |  15 +++
 .../arm/nrfmicro/nrfmicro_13_52833_defconfig  |  22 ++++
 app/boards/arm/nrfmicro/pinmux.c              |   2 +-
 7 files changed, 163 insertions(+), 7 deletions(-)
 create mode 100644 app/boards/arm/nrfmicro/nrfmicro_13_52833.dts
 create mode 100644 app/boards/arm/nrfmicro/nrfmicro_13_52833.yaml
 create mode 100644 app/boards/arm/nrfmicro/nrfmicro_13_52833_defconfig

diff --git a/app/boards/arm/nrfmicro/Kconfig b/app/boards/arm/nrfmicro/Kconfig
index 3501972231..12b0662178 100644
--- a/app/boards/arm/nrfmicro/Kconfig
+++ b/app/boards/arm/nrfmicro/Kconfig
@@ -2,9 +2,9 @@ config BOARD_ENABLE_DCDC
 	bool "Enable DCDC mode"
 	select SOC_DCDC_NRF52X
 	default y
-	depends on (BOARD_NRFMICRO_11 || BOARD_NRFMICRO_11_FLIPPED || BOARD_NRFMICRO_13)
+	depends on (BOARD_NRFMICRO_11 || BOARD_NRFMICRO_11_FLIPPED || BOARD_NRFMICRO_13 || BOARD_NRFMICRO_13_52833)
 
 config BOARD_NRFMICRO_CHARGER
 	bool "Enable battery charger"
 	default y
-	depends on (BOARD_NRFMICRO_13)
+	depends on (BOARD_NRFMICRO_13 || BOARD_NRFMICRO_13_52833)
diff --git a/app/boards/arm/nrfmicro/Kconfig.board b/app/boards/arm/nrfmicro/Kconfig.board
index 36b2d55e8b..244242a936 100644
--- a/app/boards/arm/nrfmicro/Kconfig.board
+++ b/app/boards/arm/nrfmicro/Kconfig.board
@@ -14,3 +14,7 @@ config BOARD_NRFMICRO_11_FLIPPED
 config BOARD_NRFMICRO_13
 	bool "nrfmicro_13"
 	depends on SOC_NRF52840_QIAA
+
+config BOARD_NRFMICRO_13_52833
+	bool "nrfmicro_13_52833"
+	depends on SOC_NRF52833_QIAA
diff --git a/app/boards/arm/nrfmicro/Kconfig.defconfig b/app/boards/arm/nrfmicro/Kconfig.defconfig
index a3c02c2241..40f8514480 100644
--- a/app/boards/arm/nrfmicro/Kconfig.defconfig
+++ b/app/boards/arm/nrfmicro/Kconfig.defconfig
@@ -3,7 +3,7 @@
 # Copyright (c) 2020 The ZMK Contributors
 # SPDX-License-Identifier: MIT
 
-if BOARD_NRFMICRO_11 || BOARD_NRFMICRO_11_FLIPPED || BOARD_NRFMICRO_13
+if BOARD_NRFMICRO_11 || BOARD_NRFMICRO_11_FLIPPED || BOARD_NRFMICRO_13 || BOARD_NRFMICRO_13_52833
 
 config BOARD
 	default "nrfmicro"
@@ -30,7 +30,7 @@ config ZMK_USB
 config PINMUX
 	default y
 
-if BOARD_NRFMICRO_13
+if BOARD_NRFMICRO_13 ||	BOARD_NRFMICRO_13_52833
 
 config BOARD_NRFMICRO_CHARGER
 	default y
@@ -38,6 +38,6 @@ config BOARD_NRFMICRO_CHARGER
 config BOARD_NRFMICRO_CHARGER
 	default y
 
-endif # BOARD_NRFMICRO_13
+endif # BOARD_NRFMICRO_13 || BOARD_NRFMICRO_13_52833
 
-endif # BOARD_NRFMICRO_11 || BOARD_NRFMICRO_11_FLIPPED || BOARD_NRFMICRO_13
+endif # BOARD_NRFMICRO_11 || BOARD_NRFMICRO_11_FLIPPED || BOARD_NRFMICRO_13 || BOARD_NRFMICRO_13_52833
diff --git a/app/boards/arm/nrfmicro/nrfmicro_13_52833.dts b/app/boards/arm/nrfmicro/nrfmicro_13_52833.dts
new file mode 100644
index 0000000000..01a80e3d1c
--- /dev/null
+++ b/app/boards/arm/nrfmicro/nrfmicro_13_52833.dts
@@ -0,0 +1,115 @@
+/*
+ * Copyright (c) 2020 The ZMK Contributors
+ *
+ * SPDX-License-Identifier: MIT
+ */
+
+/dts-v1/;
+#include <nordic/nrf52833_qiaa.dtsi>
+#include "arduino_pro_micro_pins.dtsi"
+
+/ {
+	model = "nrfmicro";
+	compatible = "joric,nrfmicro";
+
+	chosen {
+		zephyr,code-partition = &code_partition;
+		zephyr,sram = &sram0;
+		zephyr,flash = &flash0;
+	};
+
+	leds {
+		compatible = "gpio-leds";
+		blue_led: led_0 {
+			gpios = <&gpio1 10 GPIO_ACTIVE_HIGH>;
+			label = "Blue LED";
+		};
+	};
+
+	ext-power {
+		compatible = "zmk,ext-power-generic";
+		label = "EXT_POWER";
+		control-gpios = <&gpio1 9 GPIO_ACTIVE_LOW>;
+	};
+
+	vbatt {
+		compatible = "zmk,battery-voltage-divider";
+		label = "BATTERY";
+		io-channels = <&adc 2>;
+		output-ohms = <2000000>;
+		full-ohms = <(2000000 + 820000)>;
+	};
+};
+
+&adc {
+	status = "okay";
+};
+
+&gpiote {
+	status = "okay";
+};
+
+&gpio0 {
+	status = "okay";
+};
+
+&gpio1 {
+	status = "okay";
+};
+
+&i2c0 {
+	compatible = "nordic,nrf-twi";
+	sda-pin = <15>;
+	scl-pin = <17>;
+};
+
+&uart0 {
+	compatible = "nordic,nrf-uarte";
+	tx-pin = <6>;
+	rx-pin = <8>;
+};
+
+&usbd {
+	status = "okay";
+};
+
+
+&flash0 {
+	/*
+	 * For more information, see:
+	 * http://docs.zephyrproject.org/latest/devices/dts/flash_partitions.html
+	 */
+	partitions {
+		compatible = "fixed-partitions";
+		#address-cells = <1>;
+		#size-cells = <1>;
+
+		sd_partition: partition@0 {
+			label = "softdevice";
+			reg = <0x00000000 0x00026000>;
+		};
+		code_partition: partition@26000 {
+			label = "code_partition";
+			reg = <0x00026000 0x00046000>;
+		};
+
+		/*
+		 * The flash starting at 0x0006c000 and ending at
+		 * 0x00073fff is reserved for use by the application.
+		 */
+
+		/*
+		 * Storage partition will be used by FCB/LittleFS/NVS
+		 * if enabled.
+		 */
+		storage_partition: partition@6c000 {
+			label = "storage";
+			reg = <0x0006c000 0x00008000>;
+		};
+
+		boot_partition: partition@74000 {
+			label = "adafruit_boot";
+			reg = <0x00074000 0x0000c000>;
+		};
+	};
+};
diff --git a/app/boards/arm/nrfmicro/nrfmicro_13_52833.yaml b/app/boards/arm/nrfmicro/nrfmicro_13_52833.yaml
new file mode 100644
index 0000000000..768a59c9c4
--- /dev/null
+++ b/app/boards/arm/nrfmicro/nrfmicro_13_52833.yaml
@@ -0,0 +1,15 @@
+identifier: nrfmicro_13_52833
+name: nrfmicro_13_52833
+type: mcu
+arch: arm
+toolchain:
+  - zephyr
+  - gnuarmemb
+  - xtools
+supported:
+  - adc
+  - usb_device
+  - ble
+  - ieee802154
+  - pwm
+  - watchdog
diff --git a/app/boards/arm/nrfmicro/nrfmicro_13_52833_defconfig b/app/boards/arm/nrfmicro/nrfmicro_13_52833_defconfig
new file mode 100644
index 0000000000..256c5a5050
--- /dev/null
+++ b/app/boards/arm/nrfmicro/nrfmicro_13_52833_defconfig
@@ -0,0 +1,22 @@
+# SPDX-License-Identifier: MIT
+
+CONFIG_SOC_SERIES_NRF52X=y
+CONFIG_SOC_NRF52833_QIAA=y
+CONFIG_BOARD_NRFMICRO_13_52833=y
+
+# Enable MPU
+CONFIG_ARM_MPU=y
+
+# enable GPIO
+CONFIG_GPIO=y
+
+CONFIG_USE_DT_CODE_PARTITION=y
+
+CONFIG_MPU_ALLOW_FLASH_WRITE=y
+CONFIG_NVS=y
+CONFIG_SETTINGS_NVS=y
+CONFIG_FLASH=y
+CONFIG_FLASH_PAGE_LAYOUT=y
+CONFIG_FLASH_MAP=y
+CONFIG_CLOCK_CONTROL_NRF=y
+CONFIG_CLOCK_CONTROL_NRF_K32SRC_RC=y
diff --git a/app/boards/arm/nrfmicro/pinmux.c b/app/boards/arm/nrfmicro/pinmux.c
index dc3bf6c235..ef5b552132 100644
--- a/app/boards/arm/nrfmicro/pinmux.c
+++ b/app/boards/arm/nrfmicro/pinmux.c
@@ -14,7 +14,7 @@
 static int pinmux_nrfmicro_init(const struct device *port) {
     ARG_UNUSED(port);
 
-#if CONFIG_BOARD_NRFMICRO_13
+#if (CONFIG_BOARD_NRFMICRO_13 || CONFIG_BOARD_NRFMICRO_13_52833)
     const struct device *p0 = device_get_binding("GPIO_0");
 #if CONFIG_BOARD_NRFMICRO_CHARGER
     gpio_pin_configure(p0, 5, GPIO_OUTPUT);

From 2065602b3cacc5f37f47b18ffe01ca447dc7079c Mon Sep 17 00:00:00 2001
From: Alexander Krikun <krikun98@gmail.com>
Date: Sun, 31 Oct 2021 23:04:32 +0300
Subject: [PATCH 2/4] Proper pin definitions

---
 .../arduino_pro_micro_pins_52833.dtsi         | 59 +++++++++++++++++++
 app/boards/arm/nrfmicro/nrfmicro_13_52833.dts |  4 +-
 2 files changed, 61 insertions(+), 2 deletions(-)
 create mode 100644 app/boards/arm/nrfmicro/arduino_pro_micro_pins_52833.dtsi

diff --git a/app/boards/arm/nrfmicro/arduino_pro_micro_pins_52833.dtsi b/app/boards/arm/nrfmicro/arduino_pro_micro_pins_52833.dtsi
new file mode 100644
index 0000000000..19ce99b757
--- /dev/null
+++ b/app/boards/arm/nrfmicro/arduino_pro_micro_pins_52833.dtsi
@@ -0,0 +1,59 @@
+/*
+ * Copyright (c) 2020 The ZMK Contributors
+ *
+ * SPDX-License-Identifier: MIT
+ */
+
+
+/ {
+	pro_micro: connector {
+		compatible = "arduino-pro-micro";
+		#gpio-cells = <2>;
+		gpio-map-mask = <0xffffffff 0xffffffc0>;
+		gpio-map-pass-thru = <0 0x3f>;
+		gpio-map
+			= <0 0 &gpio0 8 0>		/* D0 */
+			, <1 0 &gpio0 6 0>		/* D1 */
+			, <2 0 &gpio0 15 0>		/* D2 */
+			, <3 0 &gpio0 17 0>		/* D3 */
+			, <4 0 &gpio0 20 0>		/* D4/A6 */
+			, <5 0 &gpio0 13 0>		/* D5 */
+			, <6 0 &gpio0 24 0>		/* D6/A7 */
+			, <7 0 &gpio0 9 0>		/* D7 */
+			, <8 0 &gpio0 10 0>		/* D8/A8 */
+			, <9 0 &gpio1 6 0>		/* D9/A9 */
+			, <10 0 &gpio1 11 0>	/* D10/A10 */
+			, <16 0 &gpio0 28 0>	/* D16 */
+			, <14 0 &gpio0 3 0>	/* D14 */
+			, <15 0 &gpio1 5 0>	/* D15 */
+			, <18 0 &gpio0 2 0>	/* D18/A0 */
+			, <19 0 &gpio0 29 0>	/* D19/A1 */
+			, <20 0 &gpio0 31 0>	/* D20/A2 */
+			, <21 0 &gpio0 30 0>	/* D21/A3 */
+			;
+	};
+
+	pro_micro_a: connector_a {
+		compatible = "arduino-pro-micro";
+		#gpio-cells = <2>;
+		gpio-map-mask = <0xffffffff 0xffffffc0>;
+		gpio-map-pass-thru = <0 0x3f>;
+		gpio-map
+			= <0 0 &gpio0 2 0>	/* D18/A0 */
+			, <1 0 &gpio0 29 0>	/* D19/A1 */
+			, <2 0 &gpio0 31 0>	/* D20/A2 */
+			, <3 0 &gpio0 30 0>	/* D21/A3 */
+			, <6 0 &gpio0 20 0>	/* D4/A6 */
+			, <7 0 &gpio0 24 0>	/* D6/A7 */
+			, <8 0 &gpio0 10 0>	/* D8/A8 */
+			, <9 0 &gpio1 6 0>	/* D9/A9 */
+			, <10 0 &gpio1 11 0>	/* D10/A10 */
+			;
+	};
+};
+
+
+pro_micro_d: &pro_micro {};
+pro_micro_i2c: &i2c0 {};
+pro_micro_spi: &spi0 {};
+pro_micro_serial: &uart0 {};
diff --git a/app/boards/arm/nrfmicro/nrfmicro_13_52833.dts b/app/boards/arm/nrfmicro/nrfmicro_13_52833.dts
index 01a80e3d1c..a8273fd602 100644
--- a/app/boards/arm/nrfmicro/nrfmicro_13_52833.dts
+++ b/app/boards/arm/nrfmicro/nrfmicro_13_52833.dts
@@ -6,7 +6,7 @@
 
 /dts-v1/;
 #include <nordic/nrf52833_qiaa.dtsi>
-#include "arduino_pro_micro_pins.dtsi"
+#include "arduino_pro_micro_pins_52833.dtsi"
 
 / {
 	model = "nrfmicro";
@@ -21,7 +21,7 @@
 	leds {
 		compatible = "gpio-leds";
 		blue_led: led_0 {
-			gpios = <&gpio1 10 GPIO_ACTIVE_HIGH>;
+			gpios = <&gpio0 25 GPIO_ACTIVE_HIGH>;
 			label = "Blue LED";
 		};
 	};

From 955d4be276f02f501fdabf00c8637bc15b15b2a1 Mon Sep 17 00:00:00 2001
From: Alexander Krikun <krikun98@gmail.com>
Date: Sun, 31 Oct 2021 23:13:49 +0300
Subject: [PATCH 3/4] Fixed 1.11

---
 app/boards/arm/nrfmicro/arduino_pro_micro_pins_52833.dtsi | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/app/boards/arm/nrfmicro/arduino_pro_micro_pins_52833.dtsi b/app/boards/arm/nrfmicro/arduino_pro_micro_pins_52833.dtsi
index 19ce99b757..651edb9416 100644
--- a/app/boards/arm/nrfmicro/arduino_pro_micro_pins_52833.dtsi
+++ b/app/boards/arm/nrfmicro/arduino_pro_micro_pins_52833.dtsi
@@ -22,7 +22,7 @@
 			, <7 0 &gpio0 9 0>		/* D7 */
 			, <8 0 &gpio0 10 0>		/* D8/A8 */
 			, <9 0 &gpio1 6 0>		/* D9/A9 */
-			, <10 0 &gpio1 11 0>	/* D10/A10 */
+			, <10 0 &gpio1 4 0>	/* D10/A10 */
 			, <16 0 &gpio0 28 0>	/* D16 */
 			, <14 0 &gpio0 3 0>	/* D14 */
 			, <15 0 &gpio1 5 0>	/* D15 */

From e5a7a33cea7b0945ef6def083bcb30359820c483 Mon Sep 17 00:00:00 2001
From: Pavel Glushkov <djlewap@gmail.com>
Date: Tue, 25 Jan 2022 19:22:58 +0300
Subject: [PATCH 4/4] Update
 app/boards/arm/nrfmicro/arduino_pro_micro_pins_52833.dtsi

Co-authored-by: Alexander Krikun <54907805+krikun98@users.noreply.github.com>
---
 app/boards/arm/nrfmicro/arduino_pro_micro_pins_52833.dtsi | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/app/boards/arm/nrfmicro/arduino_pro_micro_pins_52833.dtsi b/app/boards/arm/nrfmicro/arduino_pro_micro_pins_52833.dtsi
index 651edb9416..df6fe08697 100644
--- a/app/boards/arm/nrfmicro/arduino_pro_micro_pins_52833.dtsi
+++ b/app/boards/arm/nrfmicro/arduino_pro_micro_pins_52833.dtsi
@@ -47,7 +47,7 @@
 			, <7 0 &gpio0 24 0>	/* D6/A7 */
 			, <8 0 &gpio0 10 0>	/* D8/A8 */
 			, <9 0 &gpio1 6 0>	/* D9/A9 */
-			, <10 0 &gpio1 11 0>	/* D10/A10 */
+			, <10 0 &gpio1 4 0>	/* D10/A10 */
 			;
 	};
 };
